<template>
  <div v-if="isShowAlways" class="login-tool" :class="{isFixed:isFixed}">
    <div>
      <button v-if="!isLogin" @click="login">登录</button>
      <button v-if="isLogin" @click="exit">退出</button>
    </div>
    <div class="username" v-if="curUsername">您好! {{curUsername}}</div>
  </div>
</template>
<script>
const USER_NAME_KEY = '__username__'
import VuejsDialog from 'vuejs-dialog'
import 'vuejs-dialog/dist/vuejs-dialog.min.css'
import Vue from 'vue'
Vue.use(VuejsDialog, {
  html: true,
  okText: '确定',
  cancelText: '取消'
})
export default {
  name: 'vue-login-tool',
  data() {
    return {
      isLogin: false, //当前登录用户名
      curUsername: localStorage.getItem(USER_NAME_KEY) //当前登录用户名
    }
  },
  props: {
    /*
      envTypeNum为环境变量字段
      envTypeNum为0表示测试环境
      envTypeNum为1表示正式环境
      envTypeNum为2表示开发环境
    */

    envTypeNum: {
      type: Number,
      default: 2
    },
    //是否为固定定位，默认固定定位
    isFixed: {
      type: Boolean,
      default: true
    },
    //被iframe嵌套时隐藏
    isShowAlways: {
      type: Boolean,
      default: window.self === window.top
    },
    userList: {
      //账户列表
      type: Array,
      default: () => {
        return [
          {
            type: 0,
            username: 'aaa001',
            encryptUsername: `Qy2yOFaQTra1ecSrhCw5ohStafbMRva0dhLs4b3kNJeCh9bqXpwbjngRi3a34wmfkEm6qw%2BtJgaqQrO1WuxpVeEMfKi%2BjHfrp%2B6XJWH1LCtVbUmlC8PX4QBnO58L%2B0eASMf6b3QthRnVWpBNebJabwnazM3sgbBf77vVlGH5wac%3D&type=0&lv=4&method=DO%2Flpt45572HJ7tuzLoroOc3T%2F%2BXB2URPsbeREZhu%2BSYQ7y2%2F2VSuYSfBakF3QzmE9JI1Q4QGYmojwGVq6b09IeKw%2B%2Bclp2ol0brotfRpSzQUcsoIBoZ2CdOuJpyPmoctd7e04yOL3F0Md%2F6ykSSdhDfDEiZrwO%2Ba4mBp6MLq2%2BbGBuLiRJUXssgRkf6nAD1ea9SBjn2WpP3B0TxvF4mIuOq8W1rFnQbifBAaZkg9Z4gnaiBpL3DMNoWUeZUaEP%2BJ6sgyK9aKnmLGLvWp6g43cKjhzF6o%2BeujMhH735fJV3AEwVsxtjlK46tR%2FJIoCoaO2Fjoh3nhaTB79HnrMKdDg%3D%3D`
          },
          {
            type: 0,
            username: 'aaa002',
            encryptUsername: `M7gkna%20kclSTEsmFi27HMKkU79EpsEyZkRO9dfwPmvQz%2FCaR3GSeg5QscPRkVJgPtp1cFBh64D%2FH%209OLqq%2Ff%2FKoZpGIqwRWLvINn8plZOWAHD08qnOXn38H4PgIPnpew2lxcEo1cGQ4KeSzqmbNvFVkbcugJldktVgGT504thxQ%3D`
          },
          {
            type: 0,
            username: 'aaa0003',
            encryptUsername: `NhGgrSdGCYwHMBFuS0X2079yjvssoY%2BcsqyZZqhjQHF9%2FPQ%2BxTKrmXVmN%2BDKOeefidyj%2FMvdHfYuIk%2FbzAzSjDYlKZirazHLldba1IFPuylhU8U%2FIgaYntBotoB7mN5dxp4fl8NRqwO8u0pIm%2Bh1PpThuM7HkhjutnMjm1g9E1Q%3D&type=0&lv=4&method=RK9WYGzrKWfw2CLsLW8aHDEAOtv9XnYUVI1bWAtA7qY5bi8RpLnxwvo%2B5RsC%2FeJRGrJKo621MSLNln2ROnhdsPjZumylvydanVRW8J8blSHdRpzwEun4Rur7rtg7AfYOJS%2FliUuATFfVkLKF8KgaVHT%2Fu1s%2BclE5THAGVo4XeW%2BCKEyURnu9isBPxZmekRsbuCYNeCOfioG6uLV6JXyp0Ug6SEQGga0CfOURojD%2BLvFlZCfSvadbzFAuXsMIiiiFsJgaYxBL3QSphmouZt81ZNvOg3%2BcYHiBoa%2B5M3odHHCAuAX7JkRtHHsFwBfs8zhysRVpnuIZpP87sp%2BxLLLWJg%3D%3D`
          },
          {
            type: 0,
            username: 'aaa0004',
            encryptUsername: `CY9%2BUgKap3rhjbeDxqlQ9G8C32clrF%2Fzbokud2omJTERMd3da%2FO1xh9kma8jBwsV6IGDnR1qZoL6xmqzVd6kI0D%2FmiJhAA14XEvaBORMUOme7iCiBvACI%2FRnYjpjhkLm67EMmaKAH5GPhKUUd80D7S6Psja2wzqZ2oEBZkd2Voc%3D&type=0&lv=4&method=K7wZYKxcDX%2BkqRk2UIi95YrU3w0SKUXuVqffrLfnF%2F9HE73T961leEpf6D41bsj56DqJW7mN8vrAMzpOqCDRnYWo%2Bam3QKedzhG6rchxiWXQ6iMJMXVscJumUGDn5%2FJgSmcx2Efst2ODuIK7Z8vrWmNj%2F6vPtS1rIT1HHfPKzpulFSeKG3h4VuN11zpz40BrFpOiW%2FKiFoc2stn11%2B9uoTOFTDPn%2FJIX%2Bkcv0sW%2B9zIEMkjFZbv64q6C2XPQnHZ%2B57fAIelRoFkpzokXeWTvo6qZHmj0WWP1kZj3ORaaPKwvnq4BXljtCpXyk9dL7zMPcfDIPmKlLCApcTqHuMotXQ%3D%3D`
          },
          {
            type: 0,
            username: 'aaa0005',
            encryptUsername: `g2unhpyZk78ZOidUxwAj8Q4qqstrYrxJLe3eMSW9fNHpW%2Fk0X0HubOSzJNy5K4sscT6SNUvjlyoyqW%2FsCnHooSeuTDN8Eeu%2FLfxXZapxIGjuPIHO2%2FCTfSQh8SFmuuGZMRlkISlBlK6EqWmWUaAJ3HO7Jy68055r6%2FNoOLjcO9A%3D`
          },
          {
            type: 1,
            username: 'yili001',
            encryptUsername: `pf8Toi1qTUH9n9fYTQub7zb4fsfG8VVFf7tYV2VvbwEUJIOsBCns6wdwvOguKSEg8WWWxYK%2BNAlRvSoCNb8U8otGEG3kp5ZLCATIIgs3IWHjNU2t7tgCkSGBMqFWA1hx6NvDHn8LVFIh223rsHBZMF1DhLwNNKqIKGmf5NvICCA%3D`
          },
          {
            type: 1,
            username: 'yili002',
            encryptUsername: `nShTwl7HfA4RI0gWNwAHC9q2GXk7AY8xJ4bUCQ5q5l1MdkPsYlSTd76j59aNKzKGX%2BkjoT3cw39LtF7VtkgyWw80z01sHWu9UiVd%2Fqqv2iN%2Bnb3VCuGgT7e%2Bjxy3O0RMMkLqBDPJxHoMv5Qln1uhD5SqnbJ9fgoRRxF4GoP5bXQ%3D`
          },
          {
            type: 1,
            username: 'yili003',
            encryptUsername: `gR5qs%2BCGJNgAOrd7sab%2BwXvwgdSL0BXBl2Xmv0%2FbCEzwP89BGZcXC8y9kA0vDXoU5xsqDFmlJoykiXRMEDlwl0927XxCtP9eds6I4LeF1zNXsi9ULDIBbf2xaCO5rZ%2B6SSyVmXK5DDlEjcH4L%2B4Y5zzG8spnrqSVDNtBya3cmIY%3D`
          },
          {
            type: 1,
            username: 'yili006',
            encryptUsername: `cFIwK6S9S9mH4VJ8b6vVuSKaoj47tEV6obFGlgpSvmS7pvuV49Q92ykmBpAr53NRdSeneo2RMwStRwWmosQi3X%2Fj3KX%2BSAw57fb%2BiwENOJRgTu1C1jvmhXsCTViGZjbqtCZB8Xs8EbOhc58rlQ9sC97z2sWMeWycss%2BqAi8HvWQ%3D`
          },
          {
            type: 1,
            username: 'yili007',
            encryptUsername: `m8qZ06IedEg9z9F2mO8gsgK1snPFsmNE3NKwJxddxA6bs457cVVGJ5N4%2B20d9LsdsZGVNnlcIIBUCkcaXe%2FYx5Su%2Fq20rZdrSq8OJ16xVqHOL%2FhDuIAt6gDc68WyoeHxfGairG7SRQU2WiulwZQsG2VPtlD9d6nsvO35BgwD%2FO8%3D`
          }
        ]
      }
    }
  },
  created() {
    //处理登录
    if (this._isLogin()) {
      this.isLogin = true
    } else {
      // 清除用户名
      localStorage.setItem(USER_NAME_KEY, '')
      this.curUsername = ''
      this.isLogin = false
    }
  },
  methods: {
    //登录
    login() {
      let href = location.href
      let username = ''
      let userNameList = ''
      // 测试环境
      if (this.envTypeNum === 0) {
        userNameList = `
          测试环境账号：${this._getUserList(0)} <br/>
        `
      }
      // 正式环境
      if (this.envTypeNum === 1) {
        userNameList = `
          正式环境账号：${this._getUserList(1)}
        `
      }
      // 开发环境
      if (this.envTypeNum === 2) {
        userNameList = `
          <span style="color:red;">(PS：请选用正确的环境账号测试功能，确保账号对应到正确的后台接口，毕竟报错信息不会告诉你："您正在用测试环境账号测试正式环境后台接口"，反正都是为了你好多喝热水)</span><br/>
          测试环境账号：${this._getUserList(0)} <br/>
          正式环境账号：${this._getUserList(1)}
        `
      }
      this.$dialog
        .prompt(
          {
            title: '温馨提示',
            body: `
                请输入如下 账号 测试登录状态 <br/>
                ${userNameList}
              `
          },
          {
            promptHelp: ''
          }
        )
        .then(({ data }) => {
          username = data.trim()
          if (!username) return
          // 存储用户名
          this.isLogin = true
          this.curUsername = username
          localStorage.setItem(USER_NAME_KEY, username)

          // 获取加密后的用户名
          username = this._getEncryptUsername(username)
          // 拼接用户名参数模拟实现登录
          location.href = `${href}?username=${username}`
          //如果未hash模式，则刷新一次页面
          if (location.href.includes('#')) {
            location.reload()
          }
        })
        .catch(() => {})
    },
    //退出
    exit() {
      // 清除用户名
      localStorage.setItem(USER_NAME_KEY, '')
      this.curUsername = ''
      this.isLogin = false
      let href = location.origin
      location.href = href
    },
    //判断登录状态
    _isLogin() {
      return location.href.includes('username=')
    },
    //获取用户名列表，type值为1表示正式账号，0表示测试账号
    _getUserList(type) {
      let arr = this.userList.filter(item => item.type === type)
      return arr.map(item => item.username).join('、')
    },
    // 获取加密用户名
    _getEncryptUsername(username) {
      let res = this.userList.find(item => item.username === username)
      return res && res.encryptUsername
    }
  }
}
</script>
<style>
.isFixed {
  position: fixed;
  z-index: 999999;
  left: 0;
  top: 0;
  opacity: 0.4;
}
.login-tool button {
  padding: 30px;
  font-size: 20px;
}

.dg-container--has-input .dg-content {
  margin-bottom: 15px;
  line-height: 24px;
}
.login-tool .username {
  background: #fff;
  padding: 5px;
}
</style>